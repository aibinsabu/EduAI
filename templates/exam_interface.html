<!-- {% extends 'student_base.html' %}
{% load static %}

{% block student_content %}
<!-- Tailwind and Font setup already in base -->

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('examInterface', () => ({
            // --- Navigation State ---
            activeQuestionIndex: 0,
            totalQuestions: Number("{{ questions|length|default:0 }}"),
            answers: {}, // Track answered status for grid coloring

            // --- Camera/Proctoring State ---
            securityStep: 1,
            cameraReady: false,
            examStarted: false,
            calibrating: false,
            calibrationProgress: 0,
            calibrationSuccess: false,
            calibrationStatus: 'Looking for face...',
            checks: {
                lighting: 'pending',
                position: 'pending',
                stability: 'pending'
            },
            availableCameras: [],
            selectedCameraId: '',

            // --- Methods ---

            init() {
                // Initialize checks for already answered questions (if page reload)
                // specific implementation depends on how input values persist, 
                // for now we start clean or could read from DOM inputs
            },

            jumpToQuestion(index) {
                if (index >= 0 && index < this.totalQuestions) {
                    this.activeQuestionIndex = index;
                }
            },

            nextQuestion() {
                if (this.activeQuestionIndex < this.totalQuestions - 1) {
                    this.activeQuestionIndex++;
                }
            },

            prevQuestion() {
                if (this.activeQuestionIndex > 0) {
                    this.activeQuestionIndex--;
                }
            },

            markAnswered(index) {
                this.answers[index] = true;
            },

            // --- Camera Logic (Ported from previous version) ---
            async initCamera(deviceId = null) {
                const videoElement = document.getElementById('webcamPreview');
                if (videoElement && videoElement.srcObject) {
                    videoElement.srcObject.getTracks().forEach(track => track.stop());
                }

                const constraints = {
                    video: deviceId ? { deviceId: { exact: deviceId } } : true,
                    audio: true
                };

                try {
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    window.globalExamStream = stream;

                    if (videoElement) videoElement.srcObject = stream;

                    this.cameraReady = true;
                    this.calibrationStatus = 'Face detected. Please align with the guide.';

                    if (this.availableCameras.length === 0) {
                        const devices = await navigator.mediaDevices.enumerateDevices();
                        this.availableCameras = devices
                            .filter(device => device.kind === 'videoinput')
                            .map(device => ({
                                deviceId: device.deviceId,
                                label: device.label || `Camera ${this.availableCameras.length + 1}`
                            }));

                        const track = stream.getVideoTracks()[0];
                        this.selectedCameraId = track.getSettings().deviceId;
                    }
                } catch (err) {
                    console.error(err);
                    alert('Camera access denied. You cannot proceed.');
                    this.calibrationStatus = 'Error: Camera not accessible.';
                }
            },

            switchCamera() {
                this.initCamera(this.selectedCameraId);
                this.recalibrate();
            },

            // startCalibration() {
            //     if (!this.cameraReady) return;
            //     this.calibrating = true;
            //     this.calibrationProgress = 0;
            //     this.calibrationStatus = 'Calibrating... Please hold still.';
            //     this.checks = { lighting: 'pending', position: 'pending', stability: 'pending' };

            //     let interval = setInterval(() => {
            //         this.calibrationProgress += 2;
            //         if (this.calibrationProgress === 20) { this.checks.lighting = 'success'; this.calibrationStatus = 'Checking lighting...'; }
            //         if (this.calibrationProgress === 50) { this.checks.position = 'success'; this.calibrationStatus = 'Verifying position...'; }
            //         if (this.calibrationProgress === 80) { this.checks.stability = 'success'; this.calibrationStatus = 'Analyzing stability...'; }

            //         if (this.calibrationProgress >= 100) {
            //             clearInterval(interval);
            //             this.calibrating = false;
            //             this.calibrationSuccess = true;
            //             this.calibrationStatus = 'Calibration Complete';
            //         }
            //     }, 40);
            // },




            startCalibration() {
                if (!this.cameraReady) return;

                this.calibrating = true;
                this.calibrationSuccess = false;
                this.calibrationProgress = 0;
                this.calibrationStatus = "Hold still and look at the center";

                const canvas = document.createElement('canvas');
                const video = document.getElementById('webcamPreview');

                const interval = setInterval(async () => {
                    if (!video || video.videoWidth === 0) return;

                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);

                    const frameData = canvas.toDataURL('image/jpeg', 0.6);

                    try {
                        const res = await fetch("{% url 'proctoring_stream' %}", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ image: frameData })
                        });

                        const data = await res.json();

                        if (data.status === "Calibrating") {
                            this.calibrationProgress = Math.min(this.calibrationProgress + 3, 95);
                            this.calibrationStatus = data.message || "Calibrating...";
                        } else if (data.status === "Calibrated") {
                            this.calibrationProgress = 100;
                            this.calibrationStatus = "Calibration Complete";
                            this.calibrating = false;
                            this.calibrationSuccess = true;
                            clearInterval(interval);
                        } else if (data.status === "Flagged") {
                            this.calibrationStatus = data.violations ? data.violations.join(", ") : "Issue Detected";
                        } else if (data.status === "Error") {
                            this.calibrationStatus = "Error: " + data.message;
                        }

                    } catch (e) {
                        console.error(e);
                    }
                }, 250);
            },





            recalibrate() {
                this.calibrationSuccess = false;
                this.calibrationProgress = 0;
                this.checks = { lighting: 'pending', position: 'pending', stability: 'pending' };
                this.calibrationStatus = 'Face detected. Please align with the guide.';
            },

            startExam() {
                this.examStarted = true;
                this.$nextTick(() => {
                    const liveFeed = document.getElementById('liveProctoringSidebar');
                    if (liveFeed && window.globalExamStream) {
                        liveFeed.srcObject = window.globalExamStream;
                        liveFeed.play().catch(e => console.error(e));
                        this.startProctoringLoop(); // Start backend monitoring
                    }
                });

                if (document.documentElement.requestFullscreen) {
                    document.documentElement.requestFullscreen().catch(e => console.log('Fullscreen optional'));
                }

                if (window.initExamTimer) window.initExamTimer();
            },

            // startProctoringLoop() {
            //     const canvas = document.createElement('canvas'); // Off-screen canvas
            //     const video = document.getElementById('liveProctoringSidebar');

            //     setInterval(async () => {
            //         if (!video || !window.globalExamStream || video.paused || video.ended) return;

            //         canvas.width = video.videoWidth;
            //         canvas.height = video.videoHeight;
            //         const ctx = canvas.getContext('2d');
            //         ctx.drawImage(video, 0, 0);

            //         const frameData = canvas.toDataURL('image/jpeg', 0.5);

            //         try {
            //             const response = await fetch('{% url "proctoring_stream" %}', {
            //                 method: 'POST',
            //                 headers: { 'Content-Type': 'application/json' },
            //                 body: JSON.stringify({ image: frameData })
            //             });

            //             const result = await response.json();

            //             if (result.status === 'Flagged') {
            //                 // Show alert div
            //                 const warningDiv = document.createElement('div');
            //                 warningDiv.className = 'fixed top-10 left-1/2 transform -translate-x-1/2 bg-red-600 text-white px-8 py-4 rounded-xl shadow-2xl z-[100] animate-bounce font-bold border-2 border-white flex items-center gap-3';
            //                 warningDiv.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <span>Warning: ' + result.violations.join(', ') + '</span>';
            //                 document.body.appendChild(warningDiv);
            //                 setTimeout(() => warningDiv.remove(), 4000);
            //             }
            //         } catch (err) {
            //             console.error('Proctoring error:', err);
            //         }
            //     }, 4000); // Check every 4 seconds
            // }


            startProctoringLoop() {
                const canvas = document.createElement('canvas');
                const video = document.getElementById('liveProctoringSidebar');

                setInterval(async () => {
                    if (!video || video.videoWidth === 0) return;

                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0);

                    const frameData = canvas.toDataURL('image/jpeg', 0.6);

                    try {
                        const res = await fetch("{% url 'proctoring_stream' %}", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ image: frameData })
                        });

                        const data = await res.json();

                        if (data.status === "Flagged") {
                            const warning = document.createElement("div");
                            warning.className = `
                    fixed top-10 left-1/2 -translate-x-1/2 
                    bg-red-600 text-white px-6 py-3 rounded-xl 
                    shadow-xl z-[999] animate-pulse
                `;
                            warning.innerText = data.violations.join(", ");
                            document.body.appendChild(warning);

                            setTimeout(() => warning.remove(), 3500);
                        }
                    } catch (e) {
                        console.error(e);
                    }
                }, 4000);
            }





        }));
    });
</script>

<style>
    .glass-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.4);
        box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
    }

    .question-nav-btn {
        transition: all 0.2s;
    }

    .question-nav-btn:hover {
        transform: translateY(-2px);
    }

    .question-nav-btn.active {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.4);
    }

    /* Custom Scrollbar for Questions Area */
    .question-area::-webkit-scrollbar {
        width: 6px;
    }

    .question-area::-webkit-scrollbar-track {
        background: transparent;
    }

    .question-area::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
    }
</style>

<div class="h-full w-full relative" x-data="examInterface">

    <!-- SECURITY WIZARD (Overlay) -->
    <!-- Re-using the same wizard logic/UI but cleaner structure -->
    <div x-show="!examStarted"
        class="fixed inset-0 z-[60] bg-slate-900/95 backdrop-blur-md flex items-center justify-center p-4">
        <!-- Step 1: Agreements -->
        <div x-show="securityStep === 1" class="glass-card w-full max-w-lg rounded-3xl p-8 text-center bg-white/90">
            <div
                class="w-20 h-20 rounded-2xl bg-gradient-to-tr from-brand-500 to-indigo-500 text-white flex items-center justify-center mx-auto mb-6 shadow-xl shadow-brand-500/20">
                <i class="fas fa-shield-alt text-4xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 mb-2 font-display">Exam Security</h2>
            <p class="text-gray-500 mb-10">We need to set up your secure environment.</p>

            <div class="space-y-4 text-left mb-10">
                <div class="flex items-center gap-4 p-4 rounded-2xl bg-slate-50 border border-slate-100">
                    <div
                        class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-green-500 shadow-sm">
                        <i class="fas fa-check"></i>
                    </div>
                    <span class="font-medium text-gray-700">Fullscreen Locked</span>
                </div>
                <div class="flex items-center gap-4 p-4 rounded-2xl bg-slate-50 border border-slate-100">
                    <div
                        class="w-10 h-10 rounded-full bg-white flex items-center justify-center text-green-500 shadow-sm">
                        <i class="fas fa-check"></i>
                    </div>
                    <span class="font-medium text-gray-700">Webcam Monitoring</span>
                </div>
            </div>

            <button @click="securityStep = 2; initCamera()"
                class="w-full py-4 rounded-2xl bg-gray-900 text-white font-bold hover:bg-black transition shadow-xl transform hover:-translate-y-1">
                Start Setup
            </button>
        </div>

        <!-- Step 2: Calibration -->
        <div x-show="securityStep === 2" style="display: none;"
            class="glass-card w-full max-w-5xl rounded-3xl p-6 bg-white flex flex-col md:flex-row gap-6">
            <div
                class="w-full md:w-2/3 relative rounded-2xl overflow-hidden bg-black aspect-video shadow-2xl shadow-black/20">
                <video id="webcamPreview" autoplay playsinline muted
                    class="w-full h-full object-cover transform scale-x-[-1]"></video>
                <!-- Overlays -->
                <div class="absolute inset-0 border-[6px] border-white/10 rounded-2xl pointer-events-none"></div>
                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                    <div class="w-64 h-80 border-2 border-dashed border-white/30 rounded-[50%] transition-all duration-300"
                        :class="{'border-green-400 border-solid shadow-[0_0_50px_rgba(74,222,128,0.3)]': calibrationSuccess}">
                    </div>
                </div>
            </div>

            <div class="w-full md:w-1/3 flex flex-col justify-center">
                <h3 class="text-2xl font-bold mb-6">Face Calibration</h3>

                <div x-show="availableCameras.length > 1" class="mb-6">
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Select
                        Camera</label>
                    <select x-model="selectedCameraId" @change="switchCamera()"
                        class="w-full p-3 rounded-xl bg-gray-50 border border-gray-200 text-gray-700 text-sm focus:ring-2 focus:ring-brand-500 outline-none">
                        <template x-for="cam in availableCameras" :key="cam.deviceId">
                            <option :value="cam.deviceId" x-text="cam.label"></option>
                        </template>
                    </select>
                </div>

                <div class="space-y-4 mb-8">
                    <!-- Status Item -->
                    <div class="flex items-center justify-between p-4 rounded-xl bg-gray-50 border border-gray-100">
                        <span class="font-medium text-gray-600">Lighting</span>
                        <i class="fas bg-white p-2 rounded-full shadow-sm"
                            :class="checks.lighting === 'success' ? 'fa-check text-green-500' : 'fa-circle text-gray-200'"></i>
                    </div>
                    <div class="flex items-center justify-between p-4 rounded-xl bg-gray-50 border border-gray-100">
                        <span class="font-medium text-gray-600">Position</span>
                        <i class="fas bg-white p-2 rounded-full shadow-sm"
                            :class="checks.position === 'success' ? 'fa-check text-green-500' : 'fa-circle text-gray-200'"></i>
                    </div>
                </div>

                <div x-show="!calibrationSuccess" class="space-y-3">
                    <p class="text-xs text-gray-400 text-center uppercase tracking-wider font-bold mb-2">Instructions
                    </p>
                    <p class="text-sm text-center text-gray-600 mb-6" x-text="calibrationStatus"></p>
                    <button @click="startCalibration()" :disabled="!cameraReady || calibrating"
                        class="w-full py-4 rounded-xl bg-brand-600 text-white font-bold hover:bg-brand-700 disabled:opacity-50 transition">
                        <span x-text="calibrating ? 'Scanning...' : 'Start Scan'"></span>
                    </button>
                </div>

                <div x-show="calibrationSuccess" style="display: none;">
                    <button @click="startExam()"
                        class="w-full py-4 rounded-xl bg-green-500 text-white font-bold hover:bg-green-600 shadow-lg shadow-green-500/30 transition animate-pulse">
                        Enter Exam Interface
                    </button>
                </div>
            </div>
        </div>
    </div>


    <!-- MAIN EXAM UI (Visible after start) -->
    <div x-show="examStarted" style="display: none;" class="flex h-screen bg-slate-50 overflow-hidden">

        <!-- LEFT: Main Question Area -->
        <div class="flex-1 flex flex-col h-full relative z-10">
            <!-- Header -->
            <header
                class="h-20 px-8 flex items-center justify-between bg-white/80 backdrop-blur-sm border-b border-gray-100">
                <div class="flex items-center gap-4">
                    <div
                        class="w-10 h-10 rounded-xl bg-brand-50 text-brand-600 flex items-center justify-center shadow-inner">
                        <i class="fas fa-book-open"></i>
                    </div>
                    <div>
                        <h1 class="font-bold text-gray-900 leading-tight">{{ exam.title }}</h1>
                        <p class="text-xs text-gray-500 font-medium">{{ exam.course.name }}</p>
                    </div>
                </div>

                <div class="hidden md:flex items-center gap-2 px-4 py-2 bg-slate-100 rounded-lg">
                    <i class="fas fa-question-circle text-gray-400"></i>
                    <span class="text-sm font-medium text-gray-600">Question <span
                            x-text="activeQuestionIndex + 1"></span> of <span x-text="totalQuestions"></span></span>
                </div>
            </header>

            <!-- Question Scroll Area -->
            <div class="flex-1 overflow-y-auto p-8 question-area">
                <form id="examForm" action="{% url 'submit_exam' exam.id %}" method="POST"
                    class="max-w-4xl mx-auto space-y-8 pb-20">
                    {% csrf_token %}

                    {% for q in questions %}
                    <!-- Question Card -->
                    <div x-show="activeQuestionIndex === {{ forloop.counter0 }}"
                        x-transition:enter="transition ease-out duration-300"
                        x-transition:enter-start="opacity-0 translate-y-4"
                        x-transition:enter-end="opacity-100 translate-y-0"
                        class="glass-card p-10 rounded-3xl bg-white relative min-h-[500px] flex flex-col">

                        <div class="flex justify-between items-start mb-8">
                            <h3 class="text-2xl font-bold text-gray-800 leading-snug">{{ q.question_text }}</h3>
                            <span
                                class="px-3 py-1 bg-gray-100 text-gray-500 text-xs font-bold uppercase rounded-md tracking-wider">
                                {{ q.question_type }}
                            </span>
                        </div>

                        <!-- Answer Input Area -->
                        <div class="flex-1">
                            {% if q.question_type == 'MCQ' %}
                            <div class="space-y-3">
                                <!-- Placeholder for MCQ options - logic needed if JSON options exist -->
                                <p class="text-gray-400 italic">Select the best answer:</p>
                                <div
                                    class="p-4 border rounded-xl hover:bg-brand-50 hover:border-brand-200 cursor-pointer transition group">
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="radio" name="question_{{ q.id }}" value="A"
                                            @change="markAnswered({{ forloop.counter0 }})"
                                            class="w-5 h-5 text-brand-600 focus:ring-brand-500">
                                        <span class="text-gray-700 font-medium group-hover:text-brand-900">Option A
                                            (Placeholder)</span>
                                    </label>
                                </div>
                                <div
                                    class="p-4 border rounded-xl hover:bg-brand-50 hover:border-brand-200 cursor-pointer transition group">
                                    <label class="flex items-center gap-3 cursor-pointer">
                                        <input type="radio" name="question_{{ q.id }}" value="B"
                                            @change="markAnswered({{ forloop.counter0 }})"
                                            class="w-5 h-5 text-brand-600 focus:ring-brand-500">
                                        <span class="text-gray-700 font-medium group-hover:text-brand-900">Option B
                                            (Placeholder)</span>
                                    </label>
                                </div>
                            </div>
                            {% else %}
                            <textarea name="question_{{ q.id }}" @input="markAnswered({{ forloop.counter0 }})"
                                class="w-full h-full min-h-[300px] p-6 rounded-2xl bg-slate-50 border-0 focus:ring-2 focus:ring-brand-500/50 resize-none text-lg leading-relaxed text-gray-700 my-auto"
                                placeholder="Type your detailed answer here..."></textarea>
                            {% endif %}
                        </div>

                        <!-- Card Footer -->
                        <div
                            class="mt-8 pt-6 border-t border-gray-100 flex justify-between items-center text-sm text-gray-400">
                            <span>Answer Saved automatically</span>
                            <span class="flex items-center gap-2"><i class="fas fa-keyboard"></i> Markdown
                                supported</span>
                        </div>
                    </div>
                    {% endfor %}
                </form>
            </div>

            <!-- Bottom Navigation Bar -->
            <div class="h-24 bg-white border-t border-slate-100 px-8 flex items-center justify-between shrink-0">
                <button @click="prevQuestion()" :disabled="activeQuestionIndex === 0"
                    class="px-6 py-3 rounded-xl border border-gray-200 text-gray-600 font-bold hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i> Previous
                </button>

                <div class="flex gap-4">
                    <button
                        class="px-6 py-3 rounded-xl text-yellow-600 font-bold hover:bg-yellow-50 transition border border-transparent hover:border-yellow-100">
                        <i class="fas fa-flag mr-2"></i> Mark for Review
                    </button>

                    <button @click="nextQuestion()" x-show="activeQuestionIndex < totalQuestions - 1"
                        class="px-8 py-3 rounded-xl bg-brand-600 text-white font-bold hover:bg-brand-700 shadow-lg shadow-brand-500/20 transition flex items-center gap-2">
                        Next Question <i class="fas fa-arrow-right"></i>
                    </button>

                    <button form="examForm" type="submit" x-show="activeQuestionIndex === totalQuestions - 1"
                        class="px-8 py-3 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 shadow-lg shadow-green-500/20 transition flex items-center gap-2">
                        Submit Exam <i class="fas fa-check-circle"></i>
                    </button>
                </div>
            </div>
        </div>


        <!-- RIGHT: Sidebar (Tools) -->
        <aside
            class="w-[350px] bg-white border-l border-gray-100 flex flex-col h-full z-20 shadow-xl shadow-gray-200/50">
            <!-- 1. Live Proctoring Feed -->
            <div class="p-6 border-b border-gray-100 bg-slate-50/50">
                <div class="flex justify-between items-center mb-3">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Live Proctoring</h4>
                    <div class="flex items-center gap-1.5 px-2 py-1 rounded-full bg-red-100 text-red-600">
                        <div class="w-1.5 h-1.5 rounded-full bg-red-500 animate-pulse"></div>
                        <span class="text-[10px] font-bold">REC</span>
                    </div>
                </div>
                <div
                    class="rounded-xl overflow-hidden shadow-inner border border-gray-200 bg-black aspect-video relative group">
                    <video id="liveProctoringSidebar" autoplay playsinline muted
                        class="w-full h-full object-cover transform scale-x-[-1] opacity-90 group-hover:opacity-100 transition"></video>
                </div>
            </div>

            <!-- 2. Timer -->
            <div class="p-8 text-center border-b border-gray-100">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">Time Remaining</p>
                <div class="text-5xl font-mono font-bold text-gray-800 tracking-tighter" id="examTimer">00:00:00</div>
                <div class="mt-4 w-full h-2 bg-gray-100 rounded-full overflow-hidden">
                    <div class="h-full bg-brand-500 rounded-full" style="width: 100%"></div> <!-- Ideally dynamic -->
                </div>
            </div>

            <!-- 3. Question Grid -->
            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar">
                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Question Navigator</h4>

                <div class="grid grid-cols-5 gap-3">
                    {% for q in questions %}
                    <button @click="jumpToQuestion({{ forloop.counter0 }})"
                        class="w-10 h-10 rounded-xl flex items-center justify-center text-sm font-bold transition-all duration-200 question-nav-btn"
                        :class="{
                            'active ring-2 ring-brand-500 ring-offset-2': activeQuestionIndex === {{ forloop.counter0 }},
                            'bg-brand-50 text-brand-700': answers[{{ forloop.counter0 }}] && activeQuestionIndex !== {{ forloop.counter0 }},
                            'bg-gray-100 text-gray-500 hover:bg-gray-200': !answers[{{ forloop.counter0 }}] && activeQuestionIndex !== {{ forloop.counter0 }}
                        }">
                        {{ forloop.counter }}
                    </button>
                    {% endfor %}
                </div>

                <!-- Legend -->
                <div class="mt-8 grid grid-cols-2 gap-y-2 text-xs text-gray-500">
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-brand-500"></div> Current
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-brand-50 border border-brand-200"></div> Answered
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full bg-gray-100 border border-gray-300"></div> Pending
                    </div>
                </div>
            </div>

        </aside>

    </div>
</div>

<script>
    const rawDuration = "{{ exam.duration|default:30 }}";
    let examDurationSeconds = parseInt(rawDuration) * 60;

    // Global Timer Function
    window.initExamTimer = function () {
        const timerDisplay = document.getElementById('examTimer');
        if (!timerDisplay) return;

        const interval = setInterval(() => {
            let hours = Math.floor(examDurationSeconds / 3600);
            let minutes = Math.floor((examDurationSeconds % 3600) / 60);
            let seconds = examDurationSeconds % 60;

            timerDisplay.textContent = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;

            if (--examDurationSeconds < 0) {
                clearInterval(interval);
                alert("Time is up! Submitting your exam.");
                document.getElementById('examForm').submit();
            }
        }, 1000);
    };

    function pad(num) {
        return num.toString().padStart(2, '0');
    }
</script>
{% endblock %} 