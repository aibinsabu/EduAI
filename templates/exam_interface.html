{% extends 'student_base.html' %}
{% load static %}

{% block student_content %}
<script src="https://cdn.tailwindcss.com"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: {
                    sans: ['Outfit', 'sans-serif'],
                },
                colors: {
                    brand: {
                        50: '#f0f9ff',
                        100: '#e0f2fe',
                        500: '#0ea5e9',
                        600: '#0284c7',
                        800: '#075985',
                        900: '#0c4a6e',
                    },
                }
            }
        }
    }
</script>
<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    body {
        background-color: #f8fafc;
        background-image:
            radial-gradient(at 0% 0%, rgba(14, 165, 233, 0.05) 0px, transparent 50%),
            radial-gradient(at 100% 0%, rgba(99, 102, 241, 0.05) 0px, transparent 50%);
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    .glass-header {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(16px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.3);
    }

    body.exam-mode {
        user-select: none;
    }

    /* Custom Radio Buttons */
    .custom-radio:checked+div {
        border-color: #0ea5e9;
        background-color: #f0f9ff;
    }

    .custom-radio:checked+div .radio-circle {
        border-color: #0ea5e9;
        background-color: #0ea5e9;
    }
</style>

<div class="h-full flex flex-col w-full" x-data="{ 
    securityStep: 1, 
    cameraReady: false, 
    examStarted: false,
    initCamera() {
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                const video = document.getElementById('webcamPreview');
                video.srcObject = stream;
                this.cameraReady = true;
            })
            .catch(err => {
                console.error(err);
                alert('Camera access denied. You cannot proceed.');
            });
    },
    startExam() {
        this.examStarted = true;
        document.documentElement.requestFullscreen().catch(e => console.log('Fullscreen optional for dev'));
        startTimer();
    }
}">

    <!-- Security Overlay / Proctoring Wizard -->
    <div x-show="!examStarted"
        class="fixed inset-0 z-[9999] bg-slate-900/90 backdrop-blur-md flex items-center justify-center p-4">

        <!-- Step 1: Agreements -->
        <div x-show="securityStep === 1" class="glass-card w-full max-w-lg rounded-2xl p-8 text-center bg-white"
            x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100">
            <div
                class="w-16 h-16 rounded-full bg-brand-50 text-brand-600 flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-shield-alt text-3xl"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Secure Exam Environment</h2>
            <p class="text-gray-500 mb-8">This exam is proctored. Please review and agree to the following rules before
                proceeding.</p>

            <div class="space-y-4 text-left mb-8">
                <div class="flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-100">
                    <i class="fas fa-expand text-gray-400 w-5"></i>
                    <span class="text-sm font-medium text-gray-700">Full screen mode will be enforced</span>
                </div>
                <div class="flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-100">
                    <i class="fas fa-video text-gray-400 w-5"></i>
                    <span class="text-sm font-medium text-gray-700">Camera & mic monitoring active</span>
                </div>
                <div class="flex items-center gap-4 p-4 rounded-xl bg-gray-50 border border-gray-100">
                    <i class="fas fa-window-restore text-gray-400 w-5"></i>
                    <span class="text-sm font-medium text-gray-700">Tab switching is strictly prohibited</span>
                </div>
            </div>

            <button @click="securityStep = 2; initCamera()"
                class="w-full py-3.5 rounded-xl bg-brand-600 text-white font-bold hover:bg-brand-700 transition shadow-lg shadow-brand-500/30">
                I Agree & Continue
            </button>
        </div>

        <!-- Step 2: System Check -->
        <div x-show="securityStep === 2" style="display: none;"
            class="glass-card w-full max-w-lg rounded-2xl p-8 text-center bg-white"
            x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0 scale-95"
            x-transition:enter-end="opacity-100 scale-100">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">System Check</h2>
            <p class="text-gray-500 mb-6">Please verify your camera and microphone are working.</p>

            <div class="relative w-full aspect-video bg-gray-900 rounded-xl overflow-hidden mb-6 border-2"
                :class="cameraReady ? 'border-green-500' : 'border-gray-200'">
                <video id="webcamPreview" autoplay playsinline muted class="w-full h-full object-cover"></video>
                <div x-show="!cameraReady" class="absolute inset-0 flex items-center justify-center text-white/50">
                    <i class="fas fa-spinner fa-spin text-3xl"></i>
                </div>
                <div x-show="cameraReady"
                    class="absolute top-3 right-3 bg-green-500 text-white text-[10px] font-bold px-2 py-1 rounded shadow-sm">
                    CONNECTED
                </div>
            </div>

            <div class="flex items-center justify-center gap-2 mb-8 text-sm">
                <span x-show="!cameraReady" class="text-orange-500 animate-pulse font-medium"><i
                        class="fas fa-circle text-[8px] mr-1"></i> Connecting devices...</span>
                <span x-show="cameraReady" class="text-green-600 font-bold"><i class="fas fa-check-circle mr-1"></i>
                    Devices Ready</span>
            </div>

            <button @click="startExam()" :disabled="!cameraReady"
                class="w-full py-3.5 rounded-xl bg-green-600 text-white font-bold hover:bg-green-700 transition shadow-lg shadow-green-500/30 disabled:opacity-50 disabled:cursor-not-allowed">
                Start Exam
            </button>
        </div>
    </div>


    <!-- Main Exam Interface -->
    <div x-show="examStarted" style="display: none;" class="flex-1 overflow-y-auto h-full pb-20 custom-scrollbar">

        <!-- Sticky Header -->
        <header class="glass-header sticky top-0 z-40 px-6 py-4 flex items-center justify-between shadow-sm">
            <div class="flex items-center gap-4">
                <div class="w-10 h-10 rounded-lg bg-brand-50 text-brand-600 flex items-center justify-center font-bold">
                    <i class="fas fa-pen-alt"></i>
                </div>
                <div>
                    <h1 class="font-bold text-gray-800 text-lg leading-tight">{{ exam.title }}</h1>
                    <p class="text-xs text-gray-500 font-medium">{{ exam.course.name }}</p>
                </div>
            </div>

            <div class="flex items-center gap-6">
                <!-- Timer -->
                <div class="flex items-center gap-3 bg-red-50 text-red-600 px-4 py-2 rounded-xl border border-red-100">
                    <i class="fas fa-stopwatch animate-pulse"></i>
                    <span id="examTimer" class="font-mono text-xl font-bold">00:00:00</span>
                </div>

                <button form="examForm" type="submit"
                    class="hidden md:block px-6 py-2.5 rounded-xl bg-brand-600 text-white font-bold hover:bg-brand-700 transition shadow-md hover:shadow-lg">
                    Submit Exam
                </button>
            </div>
        </header>

        <!-- Question Container -->
        <div class="max-w-3xl mx-auto px-6 py-10">
            <form action="{% url 'submit_exam' exam.id %}" method="POST" id="examForm" class="space-y-8">
                {% csrf_token %}

                {% if questions %}
                {% for q in questions %}
                <div class="glass-card p-8 rounded-2xl relative">
                    <span
                        class="absolute top-6 right-6 text-xs font-bold text-gray-400 uppercase tracking-wider">Question
                        {{ forloop.counter|stringformat:"02d" }}</span>
                    <h3 class="text-lg font-bold text-gray-800 mb-6 pr-8">{{ q.question_text }}</h3>

                    <div class="space-y-3">
                        <!-- Assuming SAQ/Full text answer for now based on current gen model, but structure supports others -->
                        {% if q.question_type == 'MCQ' %}
                        <!-- Placeholder for MCQ rendering if options exist -->
                        <p class="text-red-500">MCQ rendering to be implemented based on JSON options structure.</p>
                        {% else %}
                        <textarea name="question_{{ q.id }}" rows="4"
                            class="w-full p-4 rounded-xl border border-gray-200 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 outline-none transition resize-none"
                            placeholder="Type your answer here..."></textarea>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="text-center py-10">
                    <p class="text-gray-500">No questions available for this exam.</p>
                </div>
                {% endif %}

                <!-- Mobile Submit Button -->
                <button type="submit"
                    class="md:hidden w-full py-4 rounded-xl bg-brand-600 text-white font-bold hover:bg-brand-700 transition shadow-lg">
                    Submit Exam
                </button>

            </form>
        </div>
    </div>
</div>

<script>
    const rawDuration = "{{ exam.duration|default:30 }}"; // Default 30 mins for safety
    let examDurationSeconds = parseInt(rawDuration) * 60;
    let timerInterval;

    function startTimer() {
        const timerDisplay = document.getElementById('examTimer');

        timerInterval = setInterval(() => {
            let hours = Math.floor(examDurationSeconds / 3600);
            let minutes = Math.floor((examDurationSeconds % 3600) / 60);
            let seconds = examDurationSeconds % 60;

            timerDisplay.textContent = `${pad(hours)}:${pad(minutes)}:${pad(seconds)}`;

            if (--examDurationSeconds < 0) {
                clearInterval(timerInterval);
                alert("Time is up! Submitting your exam.");
                document.getElementById('examForm').submit();
            }
        }, 1000);
    }

    function pad(num) {
        return num.toString().padStart(2, '0');
    }

    // Anti-cheat warning
    window.onblur = function () {
        // You would typically log this to the server
        console.warn("User left the window");
    };
</script>
{% endblock %}